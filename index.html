<!DOCTYPE html>
<html>
<head>
<title>User ID Generator</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
<div class="container mx-auto p-8">
    <h1 class="text-3xl font-bold mb-4">User ID Generator</h1>
    <button id="createUserButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>Generate User ID
    </button>
    <div id="userId"></div>
</div>

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyB_ALVZRrzoiCsO1PUbSDDNHClr-bjdTMA",
    authDomain: "cosmiccoin-galaxy-airdrop.firebaseapp.com",
    databaseURL: "https://cosmiccoin-galaxy-airdrop-default-rtdb.firebaseio.com",
    projectId: "cosmiccoin-galaxy-airdrop",
    storageBucket: "cosmiccoin-galaxy-airdrop.appspot.com",
    messagingSenderId: "544564103496",
    appId: "1:544564103496:web:8f866098ec96c9242a8b7d",
    measurementId: "G-V2KBXHFY2D"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

async function signInAnonymously(auth) {
    return await signInAnonymously(auth);
}

async function createUser() {
    try {
        const userCredential = await signInAnonymously(auth);
        const userId = userCredential.user.uid;
        await createOrGetUser(userId);
        console.log('User ID:', userId);
        return userId;
    } catch (error) {
        console.error("Error creating user:", error);
        let errorMessage = "An unexpected error occurred. Please try again.";
        if (error.code === 'auth/operation-not-allowed') {
            errorMessage = "Anonymous authentication is not enabled. Please contact support.";
        } else if (error.code === 'auth/network-request-failed') {
            errorMessage = "Network error. Please check your internet connection and try again.";
        }
        throw new Error(errorMessage);
    }
}

async function createOrGetUser(userId) {
    return retryOperation(async () => {
        const userRef = doc(window.db, "users", userId);
        const userDoc = await getDoc(userRef);
        if (!userDoc.exists()) {
            await setDoc(userRef, {
                balance: 0,
                lastInteractionDate: null,
                daysInteracted: 0,
                lastClaimTime: null,
                completedTasks: {}
            });
        }
        return userRef;
    });
}

async function displayUserBalance(userId, elementId) {
    const userRef = doc(db, "users", userId);
    const userDoc = await getDoc(userRef);
    if (userDoc.exists()) {
        const balance = userDoc.data().balance;
        const balanceElement = document.createElement('p');
        balanceElement.innerText = `Your balance is: ${balance}`;
        document.getElementById(elementId).appendChild(balanceElement);
    }
}

async function retryOperation(operation, maxRetries = 3) {
    for (let i = 0; i < maxRetries; i++) {
        try {
            return await operation();
        } catch (error) {
            if (i === maxRetries - 1) throw error;
            await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i))); // Exponential backoff
        }
    }
}

function setButtonLoading(isLoading) {
    const button = document.getElementById('createUserButton');
    if (isLoading) {
        button.disabled = true;
        button.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Creating...';
    } else {
        button.disabled = false;
        button.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>Generate User ID';
    }
}

document.getElementById('createUserButton').addEventListener('click', async () => {
    setButtonLoading(true);
    try {
        const userId = await createUser();
        const userIdElement = document.createElement('p');
        userIdElement.className = 'userId';
        userIdElement.innerText = `Your User ID is: ${userId}`;
        document.getElementById('userId').innerHTML = ''; // Clear previous content
        document.getElementById('userId').appendChild(userIdElement);
        await displayUserBalance(userId, 'userId');
    } catch (error) {
        alert(error.message);
    } finally {
        setButtonLoading(false);
    }
});
</script>

</body>
</html>
